name: Test Tiers (CPU + Optional GPU)

on:
  push:
    branches: [main, master, develop]
  pull_request:
    branches: [main, master, develop]
  workflow_dispatch:
    inputs:
      run_gpu:
        description: "Run GPU/OpenCL validation on self-hosted runner"
        required: false
        type: boolean
        default: false

permissions:
  contents: read

jobs:
  cpu-fast:
    name: CPU Fast Tests
    runs-on: ubuntu-latest
    timeout-minutes: 20

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.12"
          cache: pip

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements-minimal.txt
          pip install -e .
          pip install pytest pytest-cov

      - name: Validate breakthrough results contract
        run: |
          python scripts/validate_breakthrough_results.py

      - name: Run fast test tier
        run: |
          set +e
          pytest tests/ -m "not slow and not gpu and not opencl" -q
          status=$?
          set -e
          if [ "$status" -eq 5 ]; then
            echo "No CPU-only tests were collected for this tier; continuing."
            exit 0
          fi
          exit "$status"

  gpu-opencl:
    name: GPU/OpenCL Full Tests
    if: ${{ github.event_name == 'workflow_dispatch' && inputs.run_gpu == true }}
    runs-on: [self-hosted, linux, gpu, opencl]
    timeout-minutes: 45

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.12"
          cache: pip

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements-minimal.txt
          pip install -e .
          pip install pytest pytest-cov

      - name: Run full GPU/OpenCL tier
        run: |
          pytest tests/ -m "gpu or opencl" -v --maxfail=1

      - name: Run flakiness stability loop
        run: |
          PYTEST_BIN=pytest ./scripts/check_flaky_critical_tests.sh 3
