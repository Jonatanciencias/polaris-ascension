# ==============================================================================
# Prometheus Configuration
# Session 17: REST API + Docker Deployment
#
# Configura scraping de métricas desde la API
# ==============================================================================

global:
  scrape_interval: 15s      # Scrape cada 15 segundos
  evaluation_interval: 15s  # Evaluar reglas cada 15 segundos
  
  # Labels externos (se agregan a todas las métricas)
  external_labels:
    monitor: 'radeon-rx580-monitor'
    environment: 'production'

# ==============================================================================
# Alertmanager configuration
# ==============================================================================
alerting:
  alertmanagers:
    - static_configs:
        - targets:
            - alertmanager:9093

# ==============================================================================
# Rule files
# ==============================================================================
rule_files:
  - "/etc/prometheus/alerts/*.yml"

# ==============================================================================
# Scrape configurations
# ==============================================================================

scrape_configs:
  
  # Prometheus self-monitoring
  - job_name: 'prometheus'
    static_configs:
      - targets: ['localhost:9090']
        labels:
          service: 'prometheus'
  
  # Radeon RX 580 API metrics
  - job_name: 'rx580-api'
    scrape_interval: 10s  # API: scrape más frecuente
    scrape_timeout: 5s
    
    static_configs:
      - targets: ['api:8000']  # Service name en docker-compose
        labels:
          service: 'api'
          hardware: 'radeon-rx580'
          session: '17'
    
    # Endpoint de métricas
    metrics_path: '/metrics'
    
    # Relabel configs (opcional)
    relabel_configs:
      - source_labels: [__address__]
        target_label: instance
        replacement: 'rx580-api'

# ==============================================================================
# Storage configuration (opcional)
# ==============================================================================

# storage:
#   tsdb:
#     retention:
#       time: 15d  # Retener métricas por 15 días
#       size: 10GB # Límite de almacenamiento

# ==============================================================================
# USAGE
# ==============================================================================
#
# Verify configuration:
#   docker-compose exec prometheus promtool check config /etc/prometheus/prometheus.yml
#
# Reload configuration:
#   docker-compose exec prometheus kill -HUP 1
#
# View targets:
#   http://localhost:9090/targets
#
# Query metrics:
#   http://localhost:9090/graph
#
# Example queries:
#   - inference_requests_total
#   - rate(inference_requests_total[5m])
#   - histogram_quantile(0.95, inference_latency_seconds)
#   - gpu_memory_used_bytes / 1024 / 1024
#
# ==============================================================================
